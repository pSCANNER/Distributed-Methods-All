
-------------------------------------------------------
--Set this variable for how many days you want to look back in your Visit Occurrence Table 
DECLARE @days_to_measure INT = 1000;
-------------------------------------------------------

DROP TABLE IF EXISTS  #tmpMeas;
select m.PERSON_ID, 
m.MEASUREMENT_CONCEPT_ID,
m.VISIT_OCCURRENCE_ID,
MEASUREMENT_ID,
m.MEASUREMENT_DATE,
m.MEASUREMENT_DATETIME,
m.VALUE_AS_NUMBER,
c.CONCEPT_CODE as loin_code ,
case when CONCEPT_ID in (3026300, 3025673, 3004501, 3021737) and VALUE_AS_NUMBER >= 200 then 1 
 when CONCEPT_ID in (3026300) and VALUE_AS_NUMBER >= 200 then 1 
 when CONCEPT_ID in (3037110) and VALUE_AS_NUMBER >= 126 then 1 
 when CONCEPT_ID in (3004410) and VALUE_AS_NUMBER >= 6.5 then 1 
else 0 end as abnormal,
case when CONCEPT_ID in (3026300, 3025673, 3004501, 3021737) then 'RBG'
 when CONCEPT_ID in (3026300) then 'PG'
 when CONCEPT_ID in (3037110) then 'FBG'
 when CONCEPT_ID in (3004410) then 'A1C'
else null end as lab_group
into #tmpMeas
from 
dbo.MEASUREMENT m
inner join dbo.CONCEPT c on c.CONCEPT_ID = m.MEASUREMENT_CONCEPT_ID
where c.CONCEPT_ID in (
3026300,
3025673,
3004501,
3021737,
3026300,
3037110,
3004410
);
---------------------------------------------------------
DROP TABLE IF EXISTS  #tmpPop;
select distinct  p.person_id,
v.VISIT_START_DATE as contact_date,
v.visit_occurrence_id
into #tmpPop
from dbo.VISIT_OCCURRENCE v
inner join dbo.PERSON p on p.PERSON_ID = v.PERSON_ID
where VISIT_CONCEPT_ID = 9202 --Outpatient only
and DATEDIFF(year, p.BIRTH_DATETIME , GETDATE() )  BETWEEN 50 AND 85.75 
and v.VISIT_START_DATE between   (GETDATE()-@days_to_measure) and GETDATE();
---------------------------------------------------------

DROP TABLE IF EXISTS  #tmpMeasAb;
select m.*  into #tmpMeasAb from #tmpMeas m
inner join #tmpPop p on p.VISIT_OCCURRENCE_ID = m.VISIT_OCCURRENCE_ID
where abnormal = 1;
---------------------------------------------------------
DROP TABLE IF EXISTS  #tmpIndexDate;
select 
cast(min(m.MEASUREMENT_DATE) as datetime) as  index_date, PERSON_ID into #tmpIndexDate  from #tmpMeasAb  m
group by PERSON_ID;
---------------------------------------------------------
DROP TABLE IF EXISTS  #tmpCohort;
select distinct  m.person_id, 'i' as in_ex_flag, 'inital cohort' as group_name  into #tmpCohort from #tmpMeasAb m
where abnormal = 1;
---------------------------------------------------------
insert into #tmpCohort (PERSON_ID, in_ex_flag, group_name)
select co.person_id, 'e', 'diabetes'  from dbo.CONDITION_OCCURRENCE co
inner join dbo.CONCEPT c on c.concept_id = co.CONDITION_CONCEPT_ID
inner join #tmpIndexDate p on p.PERSON_ID = co.PERSON_ID
where (concept_code like  '%250.%' or
concept_code like  '%E10.%' or
concept_code like  '%E11.%' 
) and
co.CONDITION_START_DATETIME  <=  cast((index_date - 90) as date);
---------------------------------------------------------
insert into #tmpCohort (PERSON_ID, in_ex_flag, group_name)
select d.PERSON_ID, 'e', 'pdm meds'  from dbo.DRUG_EXPOSURE d
inner join #tmpIndexDate i on i.person_id = d.person_id
where DRUG_CONCEPT_ID in 
(
'19122121','40231170','40231172','19048007','19068594','19053967','43013744','45774398','45777025','36249657','1718707','19067100','1586326','19034782','19048692','19091621','19030443','19090247','19090187','40170911','19100538','19052954','19018419','1515106','43013928','19023584','19099206','19099465','40164897','40165969','40229045','40164907','40163924','40171448','40243629','19122367','43526467','42708170','43013902','1525215','40164916','44816282','19065480','19078635','19078604','43013903','19069639','40164930','43526233','43525516','43525524','43525527','19037213','1502916','19067366','19091535','19098518','40171451','19135386','1597801','40163926','19036966','1590170','19012507','19012678','40166274','19024504','44785198','19045623','19016116','19016127','19026845','1586370','19061670','1567201','19078601','19078609','19080793','19077684','19066522','46234049','45775387','45774895','45775455','19006932','19006933','45775623','46287410','19012268','45774439','19024508','45774719','45774722','45774751','45774754','35602720','35602724','19009382','46287681','46287691','36249796','40163898','1718901','45774531','793114','793225','793327','793342','35605620','19018821','19017141','19135267','19053964','19032633','42705861','19032715','19100125','19100129','1596915','1356059','35201904','19026878','19090229','19016162','19088425','1560005','1513876','1510202','1596977','19005468','19101455','1596914','1547504','19124662','1597781','40239218','19077682','19078634','40164881','19078639','40243630','1596975','43013897','43013909','1597773','40165973','40166042','40164886','40164892','44816274','40164920','43525509','19009381','42708089','19063032','19054443','1516770','1516771','19054445','19123227','40165995','40165998','40171449','19135388','40163925','19044920','19036967','19078554','19024502','1596916','19078606','1502829','19022851','1502812','19078631','19078560','46234235','46234237','19078527','19024507','19012680','45774710','45774711','45774715','45774724','45774758','19047414','1547505','19027259','45892172','45892173','35602717','35602729','19016044','19006907','19125223','46233976','46287688','1718909','40176981','1513914','40163899','1592795','1592800','792697','793152','1592474','1592475','793321','793329','793331','1567235','40243974','40165989','19048414','19048009','19022237','19062451','19062998','19123869','1356057','45777024','1580747','42899447','19013926','1562586','1594973','1590165','19052955','1513843','19096854','1529352','42903059','40164929','40164943','1596974','19135320','40164888','40164904','40243626','19122368','42901620','42901622','42708166','43013924','40166002','43013896','19079986','19079293','1525220','1513877','19078638','19023425','40239219','43526468','42903113','43013912','19069637','40164911','40164905','19045627','42902606','19078529','44785477','40164923','19014272','44816085','19030576','19006909','19063034','1547507','40163927','40166814','19089883','42902571','19122316','19071136','43525540','1597799','19083252','19112791','1597792','19029029','1515250','1502811','19078555','1502830','19077636','19077638','19080064','19029061','1502810','19078607','19078526','45774755','44785470','19050436','35602721','19121940','46233948','46233970','46233978','46287686','46287689','1718711','1513915','1718905','1718912','1513916','1592803','45774438','45774533','793111','793143','46221557','36249791','793314','793316','793322','35201903','19017107','19022235','40187714','42705989','19053961','43013745','43013690','42900898','42705864','19033126','19078610','45777022','45776625','46234242','46275452','1592318','1513849','19100537','46221554','19098614','19014950','1550023','42708086','40166041','42708174','40171450','19135264','19125045','43013908','19090245','43526472','19058398','19062460','19069662','40165687','40164898','40164882','40164914','40164944','40164889','43013916','1502856','19099405','40165127','19123376','43525478','19053969','43525502','43525503','40163929','42708087','19005728','40239051','40166003','1547506','40229046','40163922','40163923','19053992','19036965','43525547','43013741','1597798','19114827','19062718','19078633','19029030','1515251','1596918','19017856','45775621','45892683','19024510','19024509','45774717','45774721','1513845','19012703','19047612','19017855','19012701','19071700','19078556','19078553','19009388','45775867','46233974','46287680','46234047','46287684','1544872','1596957','1592323','1596960','792695','45892686','40221118','793147','793826','793219','793295','793311','793336','35605622','40243975','40171535','19048412','19048033','43013746','43013689','19032741','19032745','45776621','46275390','45776622','19016161','1516976','19135263','19048693','40170305','1583722','40169223','1539403','19047637','19053994','19090226','1515249','1502855','1502905','19100479','43013884','42902823','1594976','40166037','40165686','42708088','42708090','44785833','40243632','19122366','43013918','43013921','40165994','40165997','1517998','1530014','19077681','40165972','19023426','43013919','43013922','40243633','40165976','40164947','19016047','43525530','1559728','19078027','19062453','19047640','1525218','19012679','19125217','19009384','19068551','19125041','19082658','1513850','19077659','19077637','19078603','1594975','19065822','45774435','19125051','19059621','45775999','19071495','1510206','1513881','19131582','46233969','46234043','1718600','1718604','1592653','1592656','40163889','40220853','1718913','1583727','1516981','1502910','1592794','793828','793307','793309','40163921','19021312','40243973','40165988','40171536','19048420','19048035','19052833','19053966','19053968','19100599','43013742','42900901','19032719','19032743','19016893','19009385','45777023','46234244','36249546','1718889','44785472','1529331','44816332','44506754','19025946','1560171','1531601','19090249','19101415','19021789','1544838','1560168','19053993','19053995','1586369','1586346','1567198','1559684','1597756','19071749','19018783','19023063','40229047','44785831','1596959','43013915','42901618','42708078','43013911','40164919','1559685','40164922','1547510','1525221','40165975','19078605','19023424','43013925','42901621','40168368','19069664','1597772','42901619','40164908','42708171','42902607','40165970','1586367','19025944','42708175','19123374','19047541','40168374','19024503','19047663','19099243','19101414','19017857','19036355','19075974','43525471','19012266','19078530','19078551','19112802','19006908','19024506','19024505','1597761','19021048','19079990','19078608','19090206','45892179','45774893','46234234','19055308','45775619','46287408','19078528','1597760','45774714','19012702','1597796','1597795','46274508','19040970','19040969','45892176','1510207','19006910','35604091','46274207','19010533','19010204','46233977','42544059','1513913','1718899','1718908','1592317','1592804','792691','45774442','793301','19135266','19048031','19136001','19053962','1567236','43013743','42705858','19032635','45774400','1718876','1502809','19016128','19016125','1134439','19014274','40239216','42705841','19100539','19102988','19071010','19090244','1503297','793293','1502826','40163928','40229049','40164913','40164946','40164885','19126618','43526471','43013899','40166035','44816273','19082948','19067324','19090188','40243627','42901623','43013906','19067199','1515107','19017198','44816283','40168370','19113846','40166038','19054444','19030580','1567232','19084603','1597759','1525216','1525217','40229048','40229050','19017854','40184293','19045604','1516979','19030572','19030573','19067365','40164917','40166816','19014117','19078559','19014972','1516978','19078636','19078558','19027257','19001408','19009383','1502827','1597757','19012267','1515254','45892177','19080091','1596999','19098280','35602731','35604094','19017199','45775860','46233945','42544060','36249798','1718706','19135276','1567234','1596956','1516980','40169222','1583730','40220860','40220862','1718904','1544873','40163890','1592798','45774446','45774448','793148','793154','36249793','793300','793306','793313','793341','40220371','40220375','40220376','40231171','40165990','19017109','19017143','1596958','19053965','43013747','42900895','19100126','19078525','19010509','44785476','19016130','1195334','19112800','19047827','43526465','19090180','1516766','19090221','19101456','19090204','19018784','40164910','19125049','40164891','19126619','43013905','44785829','19079465','19078632','19078637','43013929','43013900','19013812','19013975','19135265','42708079','42708167','44785473','1513912','43525492','19021785','19021491','42708091','1559729','19063000','19054446','19121938','19027001','19007850','19053963','19062455','19014896','1515253','40166815','40168379','19078557','19012270','19062457','19030575','19097024','19028937','19090181','1547508','19078552','19030579','19012269','19125047','19125043','45776000','19017221','1510208','46221581','19030445','19010532','19125219','19125221','19098992','46234041','1718599','1583729','19135405','40220770','793153','46221553','793223','793335','793344','40220373'
)
and d.DRUG_EXPOSURE_START_DATE <= index_date;
---------------------------------------------------------
insert into #tmpCohort (PERSON_ID, in_ex_flag, group_name)
select m.PERSON_ID, 'e', 'abnormal a1c' from #tmpMeasAb m
inner join #tmpIndexDate i on i.person_id = m.person_id
where m.MEASUREMENT_DATE <= cast((index_date - 90) as date)
and m.lab_group = 'A1C' ;
---------------------------------------------------------
insert into #tmpCohort (PERSON_ID, in_ex_flag, group_name)
select d.PERSON_ID, 'e', 'steroid use'  from dbo.DRUG_EXPOSURE d
inner join #tmpIndexDate i on i.person_id = d.person_id
where DRUG_CONCEPT_ID in 
(
'35201888','40161322','35201053','35202015','40166111','40240344','44814623','19056772','44814619','44785528','19129918','1506576','19007003','19075029','40168094','19133672','1548843','42799980','19102561','19061860','1518294','19032381','1548711','19030004','19033022','19098178','19033024','19016693','19012532','19033288','19034803','19012889','19013398','19017947','1356081','1356328','40169037','45777037','45777039','45777052','45776015','1636811','1548478','19029946','19076147','19011092','19049760','19053475','19033545','40234579','19017949','19052915','19045900','1518254','732893','19052722','19072947','1559855','925102','19053515','19053770','19082532','1552310','19100289','19100580','19061217','40244207','19100516','19013638','19112646','963893','19089810','19077457','1525866','1560098','1560120','19066601','19063354','19051003','1636780','1525278','19017468','19017469','19051551','19027343','19043345','19052753','1537655','19043230','19067154','1326115','19087426','19078112','19016652','920458','1541079','40225720','1551098','19060549','19022820','19043288','19133766','1636871','1585147','43014067','19134063','19135736','19128248','19130269','19130270','44506724','44506717','42708201','40222881','19135073','42902238','40169210','40224812','19129511','989878','19048699','40236392','19089826','44785107','19077130','19070310','1551100','42709139','1301154','19021316','1353351','19058651','19086946','1563674','42873993','44814588','40236089','43526416','40226596','19061617','40226598','42799890','40227443','40224837','1506314','40236649','40224813','19127437','40236075','19098143','1586810','19123728','40221835','19122931','40224792','40226330','19102769','42799762','19061147','19043506','42901118','19091494','19082720','19038786','19025988','19044120','1636872','19034013','19071437','19044076','1585206','1517148','19014436','19058478','40234824','1548924','19056329','1585115','19070910','19022474','40231378','19014790','40169567','40168427','40234059','42902108','19114216','1558496','19007061','19046325','40174073','19122808','19034356','19072601','19018084','19029505','19033380','19098197','19015331','19030797','19122780','19078087','19082502','19026257','19039177','40233948','40233950','40233952','19076981','19032347','19021284','40233170','19061141','1548199','1548197','19075846','19077089','1551042','975193','1552351','1542950','1551170','19077083','19054921','1515445','1551677','19080590','1552311','19068730','19030796','19034205','19048410','19034330','19026683','19122126','19029659','1551046','19125148','19122329','45892734','19034833','19034327','19039282','45777003','45892465','1551759','1550717','1548930','19030509','1585202','19095638','19026310','46287707','792331','792350','964312','40243196','40220773','1592249','1592253','793640','792577','1636817','19057100','43012146','36250091','36250093','1719012','1548849','19076998','19077028','45774610','45892146','793166','45892162','42628979','35603651','35606538','35606547','35606554','44785527','44785529','35202043','1326194','19015968','19059682','19102562','44785742','19029654','19026222','1518843','1518844','1518748','19113705','1548811','19114580','19029746','1518719','19029750','19029683','19033287','1518845','19016261','19017053','45777041','19127049','45777033','1510211','19029741','1598819','19126429','19043798','19052916','19100532','1514412','19044263','19047794','43532113','40166101','19122782','1559849','1559851','1506602','19063241','19083090','1548965','19015520','19072792','19053387','19099224','19008075','19052179','19061657','19050969','19072851','19013949','40231628','19100575','19048447','42900359','19012058','19072111','19020789','19122723','1343039','19080568','19068004','19070851','19073102','1517070','1551673','1549022','19043712','19063225','19068429','19099361','19070859','19043284','19061926','1511682','1518258','40226607','19129883','40169560','42708927','19135407','1549001','1549023','40234797','1548999','40235233','40231630','19129365','40168471','40224933','40173295','42873631','19135072','40168050','19129513','1584953','19019891','19019893','19079140','19084824','1301197','1506426','19065401','1301199','42902237','1506315','975168','19049821','19059579','43526420','40226597','19069795','19047792','40234047','40234048','40227461','40234039','19063448','40234802','40234803','40234805','40234806','40224814','40224823','19054650','19061611','1543032','19016868','40231631','43011840','40168090','19065968','19001521','19061150','19047316','19048396','40228392','19070725','42901293','1551714','19059577','40176999','19079460','19044296','44814174','40230108','43532627','19075671','19075385','19011492','19029597','19038385','1506707','19012535','19012538','19022093','40234056','44815877','40234470','19032171','42901998','19007659','42873630','42873632','19062986','19034357','19024533','19026013','19034620','19048391','44506399','19102815','40173347','19081626','1552348','19034307','1585204','1585148','19076997','1548196','19029022','1585062','19016866','19074491','1524813','1503527','19121176','1551122','1506606','19077058','19121383','19071256','1636815','1549105','1551676','19029063','19080181','19125246','1552424','1507736','1550720','19034648','19052466','19069001','45892521','45892522','45892523','19034329','46275019','19113791','1518851','19011129','19026798','1518751','19066431','19058934','1550719','19071697','35605080','19003154','19067756','19055813','46274194','45776627','19039383','19067752','19103019','46233829','19030064','19030065','19009822','19113865','1593079','1593084','42709180','43012143','43012145','40242524','40220772','1593248','1592257','793639','19102521','1548803','36250112','1719046','45776016','45892160','45892166','35603698','35603701','35603478','35201883','19018368','35202017','40166113','42801223','44814618','19088993','1326192','19129922','19031776','40160972','19026254','19036627','40240345','19016230','19016651','19033561','19032348','19033529','19033530','1548810','19002012','19016692','19018113','19012509','19026253','19127047','1510433','45777048','45777051','45777055','45777036','1636808','45892147','19029719','19029688','19072810','903963','19006186','19045212','40234578','19083268','19064802','1525741','44507602','19087978','19061118','19053945','19013179','19050598','19098615','19067934','19052579','19113863','19072805','19063893','40226319','19046283','19102995','19053389','19003937','19054149','19047752','19031963','42709140','1507558','1397059','1521369','19018743','19063819','19061352','19047480','19068451','19033543','1560118','19061929','19013910','19079640','19050611','19078322','19075482','1636809','1588712','44785904','19087428','19054053','1345205','19062353','986389','19034305','19006605','1584910','19082562','42902239','40230791','44506794','19060332','19060547','19072951','19095136','1511451','40169036','40234823','1585179','40234801','40228391','1585149','1543011','1585203','1515446','40235232','19135602','40171336','19127158','19135597','44785903','44785905','40165311','43526419','19130171','19135074','40224835','19128038','19020101','19023478','1511449','19067188','1551101','42709141','19022701','1551123','19067145','1301198','40226328','19057126','975505','19060509','40228302','40240362','19069797','42799732','40234046','40234049','40234052','40224836','19063481','1584952','40227459','19089040','19054688','40240777','19020360','19054722','1578205','40244441','40226329','19044670','19102819','19038851','19129808','19026063','1511685','19027009','19083654','44507546','19039286','19040994','1551715','19015163','1549024','19078059','40226790','19121890','19011868','19040158','19006965','19128781','1636875','42709133','19060861','19033818','19033842','19132475','19005778','19113050','19072113','19072093','1503528','19044680','19067052','19087784','19063118','40234060','19023448','19043849','1585176','19034355','19089090','19031623','40240349','19078089','19015752','19075462','19046746','19033528','19034353','19034354','19030165','1585144','1507706','1518293','19076145','1518259','19057129','1301241','19125519','19121178','1585066','19077128','1543003','19022177','1506605','19005328','1596799','1552382','19018978','19131465','46234185','45892492','1550716','19067754','19067755','19106055','45892527','45892528','35603920','19034806','19034807','1551760','19104152','19082740','45776634','19040996','19017251','19124092','19036915','19011874','19047835','19027330','19080558','1511683','19122333','19018281','45892463','19101172','45775255','42629536','19033021','1525764','19135949','1555972','19013971','35606205','19026872','19113334','1592182','36249938','1636819','36250110','1594148','1594153','1594157','1548807','19034832','19077023','45892156','36249965','35604711','35606542','35605780','35604730','35604740','35202042','42801219','44785761','40233894','1326142','19009425','19040124','19078371','40235165','19021376','19064778','19071220','19036625','19078342','19034663','19033563','19017051','1518749','19035205','19029747','19029748','19029771','19029658','19029681','19013464','42873492','42873493','42900325','1329416','1356327','1356333','45777040','36249969','45777032','1559875','19057625','19027194','939259','19052195','19053421','19084165','19067237','19014898','1559853','1329415','19063223','19100188','19051917','1549254','1506270','19060308','19032379','19054146','42709138','19052206','1560102','1586449','19052801','19078411','19032411','702865','1351541','19014990','19099345','993631','19069196','1558471','1515774','19124906','19050600','19015379','19050626','19015030','19078114','19034194','40227495','40225693','19072927','19063183','19054986','19061560','19113981','19087502','19060940','19102155','19102487','40221834','40236169','19134070','19129407','1543033','40171343','19135606','19135275','40236648','40224932','40240361','42707910','40234819','40233205','43526877','44814587','42902235','40162461','40228301','40162395','40162447','1363516','1578181','19130170','19129514','1552350','1522990','19078959','19058360','1301160','19101127','40225698','19078313','19018977','40169224','40239138','40239140','40234820','40234043','40234044','40234045','40234035','19075849','40228902','40224793','40224794','43011837','19006539','19034924','19069368','19068306','19048354','920917','19044539','42901133','19071748','40224791','19073090','19072748','19040993','1585121','1585067','1585070','40233159','19043312','19083292','19078120','19060816','19058622','19034011','19034012','19043690','19043350','1517151','40234568','40233877','19044232','19026251','19086094','19070613','19091520','19085522','40229333','19071890','19103007','19028398','19049279','19073139','19072095','40169568','42902111','19075945','19078414','19088541','19096521','19026064','42873628','19072091','19070857','19076031','19076033','19066474','19015393','19058223','19082506','40169563','19043254','19017065','40233946','40168523','40244036','44507518','19061019','1518261','1551192','19076135','19077056','19019001','1503525','1503529','19080159','1585114','19027421','19066946','1506479','1506312','1636147','1551674','19057122','1518257','1555142','1549104','19077088','1548198','19026717','45892594','46234179','46234188','19036600','19135838','19067727','19134135','19029714','19007005','19030794','1551761','19018365','19059135','19124096','19030005','19113806','19127439','45775338','19055140','19034835','19011940','45892466','45892467','19034360','19009827','45775252','46221378','19055211','19034232','19006967','46274209','19070900','19066528','19100454','45892624','45892626','46221383','1585178','964320','42709184','793636','19079137','1636818','1548369','43012148','1719022','19077021','19102863','45892924','35603129','35606536','35606555','42628981','35604733','35604736','35201882','35201887','19125388','1552511','1548476','44814620','44814621','19089081','19040080','1552506','19070743','1548844','40166112','19099680','40166114','40163596','1552505','19033562','19032349','19032350','19034324','19012508','19026252','19029774','19029776','19029778','19040157','19012890','19127714','42873490','1592978','45777034','19052620','19032147','19033547','19133060','19083795','1515417','19033509','19100519','19098919','19088421','19017252','19034226','19072958','1559870','19008009','1543034','19072794','19053388','975125','19047504','19043319','42899794','45776549','1502877','19088978','19023581','1510812','1522957','1549080','1366773','42900442','19100517','1560100','19049150','1543112','19061356','19044261','19088825','19063360','19072925','939871','19100466','19056413','19070854','1586808','40225697','19032413','19102442','1512674','19069243','1503501','19064946','42799060','42708841','42709132','1585145','40237279','19126169','1507735','40235231','19130122','40234038','42873629','43526415','43012434','19135075','42873461','19129512','19129290','19073208','19129289','19130168','1507705','1584983','40241504','19077129','1326143','40240359','44785105','19065600','1301161','19077127','19028005','1515447','40239137','40239139','1585228','1585242','40240366','40234055','40165312','40234042','40162448','1548968','19044270','40227458','19052714','19013493','40226594','40229092','19064776','19050599','19087430','19048189','19083483','19113578','19071638','19083517','1585071','40231786','19016867','19044142','19040967','19043341','40233945','1551234','1517202','19128374','40236912','1506711','42709134','1596800','19073047','19074144','19033820','19021723','19072099','19035189','19080744','19044071','1563703','40234058','40168796','19027577','1329477','19078292','19034203','19084601','19079418','19070882','19129987','40225828','40225836','19079488','19082355','1585150','19074184','19125245','19077515','1585069','19076474','1351624','19128372','19077481','19098113','19022066','1326201','1597238','975504','19036748','1585180','19036597','45892520','19048431','19069073','45776632','19034887','19054228','19047963','19030683','19013439','19031307','19102571','1506709','19128370','19027351','1511684','19030003','19124495','1518872','19037137','45892462','45892464','19067555','19034805','1503987','19067759','19029506','19034889','19001480','19034647','1551717','1551716','19067751','1549218','19100455','35606206','19030008','19006962','19093370','1593086','792830','964321','964335','793637','1548368','19057099','19079139','1548364','1548365','40242525','42901927','19077024','19077030','1548507','45776021','36249940','42629018','35201884','19056504','35202016','35202019','1517102','19076999','42801221','44785759','40163595','19098979','40222886','42708200','19064204','19105377','19114582','19046717','19088256','19076137','19112904','1548848','19029773','19033289','1548710','19033290','19098177','45777038','45776022','1636810','19016299','19013876','19084190','19100267','1503983','19017950','19014602','19038591','19053390','19053423','19053594','19083102','19057984','40226323','40233573','19072824','19071620','1312007','1500211','1549786','19061300','19088949','1560104','1560105','1560111','1560116','19065284','19068794','19052804','19061143','19078081','19068276','19068725','1636145','44785906','44785104','19052752','19052999','1524769','1305637','19058625','1548195','19052114','19078085','19078116','40225695','792423','40162443','19065450','43012417','1551099','19086888','1511450','1551093','40224789','40226619','42902110','40240348','40174072','1585227','40166377','42708926','40225721','42708312','40226593','40224822','40224831','40222885','42799833','43532020','19066863','43011943','40236088','19135172','1542948','19019894','19019892','1550775','1550560','42902241','19080211','19058140','42707634','19135608','1585175','19061583','1506430','1301155','1551675','40239011','1345206','40225696','40225702','19059603','42708202','1585230','1543036','19059752','40234050','40234031','40226713','40226599','40227460','40234040','40222882','43526137','40227445','1586834','40228900','1543009','40226608','40226609','19135604','1517145','19022369','19030447','43525553','40224790','19083519','19034646','19030479','19121836','40234798','40227924','40233940','19098198','19024534','19007062','19029909','19094282','43526741','19059071','19100382','40169579','40239019','19100310','40234108','1537656','42799061','19047641','19033782','19099641','40236320','19072827','19121838','1503530','19047759','19047885','19122810','19132094','19022928','19080381','19072956','19072836','19034700','19082480','43013007','19026230','19026255','19026256','40169565','40174080','19038813','19015208','40236354','19047907','19034352','19073147','19022476','19002255','44507519','1548339','19028933','19032145','1585181','19075848','1551010','19074157','1329476','1597252','1584930','975169','19078981','1555890','19019010','1555889','1549788','19077057','1515421','45892592','45892596','19102731','46274900','19067753','19034650','19126576','19048433','19001447','19069071','1551757','19049787','45774729','19031308','19030001','1502880','19080560','45775838','19095151','46274521','19055139','19037136','45892468','19033286','19067723','19067757','1542949','1543004','19033622','19034981','1548969','1592979','792429','1592183','1592245','1548363','1636781','19102225','1548416','42709181','19102226','19077022','19102864','45892154','35605468','35603652','35606545','35603484','35603716','35201886','35201889','19009458','1585231','42801225','42800056','19112651','42799760','19071182','1326196','19129926','42709125','19017495','19012510','1584927','19021374','19072949','19017052','40224832','19032346','19016229','19033023','19029772','19029777','19071500','1585036','19030002','40161323','19076138','42708199','1559878','45777049','45777056','1548508','45776020','1592983','45777035','1592238','19024531','19029910','19050533','19064771','19053008','19053988','19027002','19047735','19012690','1514483','19034572','19100520','19072954','19050595','1596779','1559877','19063895','40180287','19072691','19112548','19070383','42705422','19005046','1398693','1307026','1597235','19052201','19100693','19068300','1560110','19068691','19070677','19049781','19100497','19062251','19015513','991710','40231081','19074707','1548477','40242526','44785106','19034248','19062253','19082935','19080564','19080570','19099268','19044292','19046500','40225691','19043286','19020787','19084789','951279','19015916','19023412','19060310','19072115','19043314','42901997','42902114','19129408','19072770','40173287','40240363','40234034','44814608','43560590','43526136','44814585','19133985','42899426','19129254','19129398','19067190','1301158','1353268','1525762','1517147','1301157','1301156','19125525','40234791','19077055','40225692','40239012','43012435','1507838','19057620','43526742','42799982','40234053','40234054','40234041','19019158','40234807','40234808','40234809','1586836','42902797','19082707','19079652','43011839','19045250','19077019','43525624','42799761','1596792','19044921','40240360','44814376','44784766','1552423','1563678','1585120','40244014','19056420','19043373','19078057','40172938','19012531','19060778','19060814','40236170','40229424','19007010','19038300','40237280','19014439','19129806','19013437','19061524','1585244','1551045','19113764','40169566','19070979','19113789','19082070','19044266','19056327','19113725','19068278','40162759','1503526','19036626','19032761','19016961','19032175','19009923','19088258','19098291','1636869','44814321','1551004','19121385','19047643','19099586','19033379','19034204','40226612','19034698','1586462','43011769','1549111','40169561','40169562','40169564','19047313','19046747','19016071','42708332','19081624','19081992','19038421','1585146','1585177','19112573','19077090','19067291','19077460','1585034','19078350','19076136','1549103','19057128','19078960','1636816','1586451','1548806','45777075','45892589','19102693','19017494','1585172','19012128','45892490','19067728','45892525','45892526','35603918','19048601','1550975','19126497','19126495','19127159','19054410','19069072','1537691','1585112','19127740','19115038','45774731','19027323','19016796','45775841','19124493','19122337','19026871','45775336','19094633','19034328','19067795','19037138','45892461','19067758','42629537','42629544','1542951','19006964','19067730','1548928','19026012','19030793','46274269','35606202','35606204','19029656','19131603','1585040','792354','792427','964336','1592243','1592251','40242527','42901925','43012144','1594152','40243197','19077051','19034808','19077026','45892925','45892168','19066475','35606533','35606540','35604734','35603480','35603490','35201885','1585229','35202014','35202018','44814625','44785530','1326148','1326198','40233895','19040123','19039743','44785760','1585205','19096659','19034665','19079653','19017948','19013465','19067403','19098176','1518842','19029749','19029775','19029682','19029655','19127895','1559879','19013817','19054181','19114036','1550557','19100531','19064780','19042258','19053422','19022870','1559838','19063283','19033787','19003939','1555887','19052474','19100518','19072796','19060545','19064707','19061613','19047797','19032797','1560096','1536743','1589505','1507835','19032173','1301152','1555120','19077143','19100533','19064709','19073070','19135457','40225703','950435','19055067','19003941','42902236','19067939','19072929','40161348','19072808','19042856','42902355','42708842','42902107','1585151','19129842','19133854','40171334','40234030','40173291','40240365','42873627','19070744','42902240','1551193','19023233','19018083','19077124','40225694','19028039','44814609','40169039','19130001','19059725','40240364','43526421','40226595','40234051','40227441','40227444','1507707','40173288','40173292','40173296','40236650','40234804','40160962','1636846','40226331','19135599','19036736','19014302','1596781','19005823','19128230','19077459','40173366','19078083','19043282','19051552','19005349','19062340','40226610','19034014','19070611','19053037','19125527','19029501','19031775','925104','19055572','19053032','19014049','1636876','19015572','19000845','19051965','19063413','19132464','19015777','19083209','19072646','19044015','44784929','19071468','19043971','19075252','42873419','19076364','19072942','19102439','1552507','40234057','42902115','19122812','19017209','1585174','19036624','40226611','40230406','19039813','19066845','42706110','19089049','19069065','19021969','19063540','19061017','19068598','19018906','19064773','19077733','40240911','19077121','1551044','1552383','1537684','19019482','19076564','19072097','1518292','19080702','19021315','45777074','45892491','19035204','19012660','45892519','45892524','35603915','35602896','19034359','45776629','19040995','19034888','19029657','19124094','19049823','19030684','19029973','19124098','19112523','19134066','19002396','19034804','1503986','19098222','46274193','19112971','19034231','19040156','19034645','1551718','1551719','19098475','19125094','46221381','19128780','19002851','19066570','1593078','964311','43012147','1592247','1592261','792578','19079138','19102520','42709185','42901924','42901926','40243200','19077029','19034834','19077000','45776023','45892150','35606544','35603486','35603489','35604738','35603714')
and d.DRUG_EXPOSURE_START_DATE >  (GETDATE() - 90);
---------------------------------------------------------
delete from #tmpCohort where PERSON_ID in
(select PERSON_ID from #tmpCohort where in_ex_flag = 'e');
---------------------------------------------------------
DROP TABLE IF EXISTS  #tmpCancerMed1;
select person_id, concept_name into #tmpCancerMed1
from dbo.DRUG_EXPOSURE d 
inner join concept c on c.CONCEPT_ID = d.drug_concept_id
where
d.drug_concept_id in
('40239060','19071340','40236069','19102502','19102501','1363389','1363390','19026972','19123411','19091137','19124392','42709322','40242017','40240530','40241911','40242681','46274766','43532305','19135088','42900005','42900253','42543818','43012038','43012062','43012063','40239056','19086370','1336628','19027014','19011440','40175813','40175817','40175818','42708083','40242016','40241937','43014240','43014244','43014251','42900297','43532508','43532925','43532928','19135083','19135087','1394023','42543820','42629387','35200596','1510570','19071511','19122521','19122187','19122475','19122473','1336541','1336622','19124390','1358463','1358465','19026980','19027011','19124417','1337651','40175814','42708085','40241940','43014237','43014239','43014243','42900298','43532301','46274765','43532499','43532500','19135086','42900892','42629381','42629395','43013204','19093984','1337693','19004257','40223693','40167554','40167556','40238052','40230579','40241939','42900305','43532299','43532306','43532929','46274678','42629384','42629389','1510569','1304107','19071677','40236071','19102833','1359551','1358464','19124394','40175800','19135081','46274170','40167557','40230575','40230576','40242677','40242678','43014247','43014248','43014252','43532497','43532507','43532721','43533090','43532924','45776252','42901616','19127678','19127716','40223727','42629383','42629391','43012064','1510575','19004113','1325363','19122517','19112653','1359550','1363387','19087088','19025425','19026977','1358436','19130483','40175822','19135079','40223694','19135077','42707968','42707969','40238056','40242675','40242663','43013777','43532302','43532927','40224785','1593813','1593815','35200598','46274231','40239055','40239061','19025418','19112618','19122519','40236073','1359548','1336539','1336627','19125140','19130458','40175821','42705851','42708084','40167395','40238054','40241208','40230580','43532833','46274767','43532926','42900250','45776254','42903460','42901617','19017711','40220878','19135084','43013205','19102832','19026978','1336624','1336625','42708082','40241210','40242682','42900301','42900302','42900306','43532210','43532018','43532853','42900252','19127718','43012292','43011639','42629393')
and d.DRUG_EXPOSURE_START_DATE > GETDATE() - 180;
---------------------------------------------------------
DROP TABLE IF EXISTS  #tmpCancerMed2;
select distinct t1.person_id,
  STUFF((SELECT distinct '' + t2.concept_name
         from #tmpCancerMed1 t2
         where t1.person_id = t2.person_id
            FOR XML PATH(''), TYPE
            ).value('.', 'NVARCHAR(MAX)') 
        ,1,0,'') data
into #tmpCancerMed2 from #tmpCancerMed1 t1;
---------------------------------------------------------
DROP TABLE IF EXISTS #tmpCancerDx1;
select person_id, concept_name into #tmpCancerDx1
from dbo.CONDITION_OCCURRENCE d 
inner join concept c on c.CONCEPT_ID = d.CONDITION_OCCURRENCE_id
where
d.CONDITION_OCCURRENCE_id in
(
    select distinct concept_id_2 from
    (SELECT cr.concept_id_1, c1.vocabulAry_id, concept_id_2, c.vocabulAry_id as vocabulAry_id2 FROM dbo.CONCEPT_RELATIONSHIP cr
     INNER JOIN ( select CONCEPT_ID, concept_name, vocabulAry_id from dbo.concept where vocabulAry_id  = 'ICD10' and concept_code like 'C%') C1 on c1.concept_id = cr.concept_id_1 and relationship_id = 'Maps to'
     left join dbo.concept c on c.concept_id = cr.concept_id_2 ) t
)
and d.CONDITION_START_DATE > GETDATE() - 180;
---------------------------------------------------------
DROP TABLE IF EXISTS  #tmpCancerDx2;
select distinct t1.person_id,
  STUFF((SELECT distinct '' + t2.concept_name
         from #tmpCancerDx1 t2
         where t1.person_id = t2.person_id
            FOR XML PATH(''), TYPE
            ).value('.', 'NVARCHAR(MAX)') 
        ,1,0,'') data
into #tmpCancerDx2 from #tmpCancerDx1 t1;


----------------------------------------------------
 --Get your list of Patients 
 select * from #tmpCohort
 ----------------------------------------------------